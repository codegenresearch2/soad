Here is a shorter version of the code snippet that should be easier to test.